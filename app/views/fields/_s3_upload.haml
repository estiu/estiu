- item_wrapper = 's3-upload-item-wrapper'
- object_template = "object_template_for_#{key}"
- object_index = "object_index_for_#{key}"
- name_prefix = "#{form.object_name}[#{key}_attributes]"

.fileupload-content
  .fileupload-progress
.file-upload
  = form.label :filename, t('add_a_file'), class: 'btn btn-info'
  = form.file_field :filename, use_action_status: true, class: 'file-uploader', style: 'display: none'
= form.fields_for(key, target.send(key).build) do |f|
  = form_fields(f, locals[:translations], name_prefix: "#{name_prefix}[{{#{object_index}}}]") do |field|
    :javascript
      #{object_index} = #{target.send(key).size - 2}
      #{object_template} = #{partial_to_js_template('fields/s3_upload_item', field: field, first: false)}

:javascript
  $('.jquery-file-upload').fileupload(
    _.extend({
      done: function(event, data){
        var filename = $(data.jqXHR.responseXML).find("Location").text();
        var visible_name = data.files[0].name
        var key = $(data.jqXHR.responseXML).find("Key").text();
        $('#{all_objects_wrapper}').append(
          "<div class='#{item_wrapper}'>" +
          #{object_template}({#{object_index}: (#{object_index} += 1), filename: filename, key: key, visible_name, visible_name}) +
          "</div>"
        )
      }
    },
    DEFAULT_UPLOAD_OPTIONS)
  )
  $(document).on('click', '.remove-nested-attribute-item, .remove-nested-attribute-item *', function(){
    $(this).closest('.#{item_wrapper}').remove()
    return false
  })