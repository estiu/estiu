.row
  .bordered{class: centered}
    %h2= t '.title'
    %hr
    = form_for(campaign, class: 'form-horizontal') do |f|
      = form_fields(f, 'campaigns.form') do |field|
        - venue_capacity = capture do
          .venue-capacity.f13{style: 'margin-top: 3px'}
            %strong
              = (t '.venue_capacity') + ":"
              %span#venue-capacity-indicator
        .row
          .col-xs-6
            = field.(:venue_id, as: :select, values: Venue.for_select, after: venue_capacity)
          .col-xs-6.right
            = link_to(t('venues.form.other'), '#', id: 'other-venue', class: 'btn btn-info btn-xs')
        = field.(:name)
        = field.(:description, as: :textarea)
        .row
          .col-xs-6
            = field.(:goal_cents, as: :currency, min: Campaign::MINIMUM_GOAL_AMOUNT, max: Campaign::MAXIMUM_GOAL_AMOUNT)
          .col-xs-6
            #recommended-pledge-indicator.f12.alert.alert-info.p10{style: 'margin-top: 22px'}
        .row
          .col-xs-6
            = field.(:minimum_pledge_cents, as: :currency, max: Pledge::MAXIMUM_PLEDGE_AMOUNT)
          .col-xs-6
            #attendance-indicator.f12.alert.alert-warning.p10{style: 'margin-top: 22px'}= t('.maximum_attendance') + ':'
        .row
          .col-xs-6
            = field.(:starts_at, as: :datetime)
          .col-xs-6
            = field.(:ends_at, as: :datetime)
        %hr
        .right
          = field.(:submit)
          
:javascript
  
  window.venue_capacities = #{Venue.venue_capacities.to_json}
  
  $('#campaign_venue_id').change(function(){
    $("#venue-capacity-indicator").text(window.venue_capacities[$(this).val()] || "")
  }).change()
  
  function update_recommended_pledge(){
    var capacity = window.venue_capacities[$('#campaign_venue_id').val()] || "#{t 'campaigns.form.venue_capacity'}"
    var facade = $('#campaign_goal_cents_facade').val()
    var goal = $('#campaign_goal_cents').val()
    var result;
    if (facade && goal && !isNaN(capacity) && !isNaN(goal)){
      var _goal = new Number(goal)
      var _capacity = new Number(capacity)
      result = (_goal / _capacity / 100.0).toFixed(2)
      $('#campaign_minimum_pledge_cents_facade').attr('placeholder', result)
    } else {
      result = "#{t 'campaigns.form.minimum_pledge_cents_short'}"
      $('#campaign_minimum_pledge_cents_facade').attr('placeholder', null)
    }
    result = '<strong>' + result + '</strong>'
    var money = facade || "#{t 'campaigns.form.goal_cents'}"
    var caption = money + " / " + capacity + " = " + result
    $('#recommended-pledge-indicator').html(caption)
  }
  
  $('#campaign_goal_cents_facade').bind('cents_field_updated', update_recommended_pledge)
  update_recommended_pledge()
  
  function update_attendance_indicator(){
    var caption = "#{t '.maximum_attendance'}"
    var goal = $('#campaign_goal_cents').val()
    var pledge = $('#campaign_minimum_pledge_cents').val()
    var value = ""
    if (goal && pledge && pledge != "0") { // "0": because of autonumeric's min.
      value = Math.floor(goal / pledge)
    }
    $('#attendance-indicator').html(caption + ": " + value)
  }
  
  $('#campaign_goal_cents_facade, #campaign_minimum_pledge_cents_facade').bind('cents_field_updated', update_attendance_indicator)